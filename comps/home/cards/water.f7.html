<template>
  <div @click=${(e)=>redir(e)} class="cardd water">
    <div id="teachCircle"></div>
    ${hold ? $h`
      
      <div class="hold">
      <${gauge} key='y' size='120' fsize='150'/>

      <div class="control">
        <div class="50">
          <div class="pl btnn" @click=${(e)=>{ change(50)}}>+</div>
            50
          <div class="mi btnn" @click=${(e)=>{ change(-50)}}>-</div>
        </div>
        <div class="100">
          <div class="pl btnn" @click=${(e)=>{ change(100)}}>+</div>
            100
          <div class="mi btnn" @click=${(e)=>{ change(-100)}}>-</div>
        </div>
        <div class="200">
          <div class="pl btnn" @click=${(e)=>{ change(200)}}>+</div>
            200
          <div class="mi btnn" @click=${(e)=>{ change(-200)}}>-</div>
        </div>
      </div>
      </div>


    ` : $h`
    <span>Водичка</span>
    <!-- <img src="static/bottle.svg" alt=""/> -->
    ${!$store.state.appData.desktop ? $h`
      <div class="gaugeControl">
        <div @click=${(e)=>{change(-100, true, e.target)}} class="minus btn">-100</div>
        <${gauge} key='l' fsize='100' size='80'/>
        <div @click=${(e)=>{change(100, true, e.target)}} class="plus btn">+100</div>
      </div>
      ` : $h`
      <${waterBox}/>
      <div class="la">выберите, сколько выпили:</div>
      <div class="cups">
        <${cup} ml='50' scale='0.6' img1='cup50'/>
        <${cup} ml='100' scale='0.8' img1='cup100'/>
        <${cup} ml='200' scale='1' img1='cup200'/>
      </div>
      `}
    `}

  </div>
</template>
<script>
    import waterBox from './../../water/waterBox.f7.html';
  import cup from './../../water/cup.f7.html';
  import gauge from './waterGauge.f7.html'
  export default (props, {$store, $f7, $update, $el, $, $onMounted}) => {
    var bodymovin = require('../../../js/lottie');



    let hold = false
    
    function bouns(el) {
      el.style.transform='scale(1.1)'
      setTimeout(() => {
        el.style.transform='scale(1)'
      }, 200);
    }


        

    $f7.on('e-waterChange', (val)=>{
      change(val)
    })

    function change(ml, b=false, el) {

      if ($store.state.userData.water.todayMl >= $store.state.userData.water.goal &&
      $store.state.userData.water.todayMl+ml < $store.state.userData.water.goal) {

        $f7.emit('e-goal', '-')
        $f7.emit('e-changeLvl', -100)
      }else if($store.state.userData.water.todayMl < $store.state.userData.water.goal &&
      $store.state.userData.water.todayMl+ml >= $store.state.userData.water.goal){
        $f7.emit('e-goal', '+')
        $f7.emit('e-changeLvl', 100)
      }

      if ($store.state.userData.water.todayMl+ml >= $store.state.userData.water.goal) {
        
      }

      if ($store.state.userData.water.todayMl+ml >= 0) {
        $store.state.userData.water.todayMl+=ml
        doo()
      }else if ($store.state.userData.water.todayMl == 0 && ml<=0){

      }else if ($store.state.userData.water.todayMl+ml <0){
        $store.state.userData.water.todayMl=0
        doo()
      }

      

      

      function doo() {
        if (b) { bouns(el)}
      navigator.vibrate([30])
      $f7.emit('e-backp')
      $f7.emit('e-waterChange')
      }



    }

    function holdChange() {
      navigator.vibrate([30, 10, 30,])
        $f7.emit('e-waterCardHold')
        hold=hold?false:true
        $update()
    }


    var toastBottom = $f7.toast.create({
          text: 'Зажмите на карточке для дополнительных действий',
          closeButton: true,
          on: {
            close: function () {
              $store.state.userData.teach.widgetPress=true
              $f7.emit('e-backp')
            },
          }
        });


    $onMounted(()=>{
      $('.card,.water').on('taphold', function () {
        if ($store.state.userData.teach.widgetPress !== true) {
          $store.state.userData.teach.widgetPress = true
          $f7.emit('e-backp')
        }
        toastBottom.close()
        holdChange()
      });




      if ($store.state.userData.teach.widgetPress !== true && !$store.state.appData.desktop) {
      setTimeout(() => {
        
        toastBottom.open();

        setTimeout(() => {
          var animation = lottie.loadAnimation({
          container: document.getElementById('teachCircle'), // Required
          path: 'static/teachCircle.json', // Required
          renderer: 'svg', // Required
          loop: false,
          autoplay: false, // Optional
        })
        $('.card,.water').css('box-shadow', 'var(--waterCardBSH), 0 0 0 1000px #0000005e')

        animation.play()  
        animation.pause()  
        
        setTimeout(() => {
          animation.setSpeed(1)  
          animation.play()  
        


        $('.card,.water').addClass('active-state')


        setTimeout(() => {
          $('.card,.water').removeClass('active-state')

          holdChange()
          $('#teachCircle').css('opacity', '0')
          setTimeout(() => {
            $('#teachCircle').remove()
             animation.destroy()

            $('.card,.water').css('box-shadow', 'var(--waterCardBSH)')

          }, 500);
        }, 500);
        }, 1000);
        }, 3000);
      }, 2500);

      }
    })

    function redir(ev) {
      let path = ev.path
      let fClasses = [...path[0].classList]
      let no = ['btn', 'btnn', 'cup']
      if (!no.some(el => fClasses.join(' ').includes(el))) {
        $f7.views.current.router.navigate('water/')
      }
    }


    return $render;
  }
</script>