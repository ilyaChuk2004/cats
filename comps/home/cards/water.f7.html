<template>
  <div class="cardd water">
    <div id="teachCircle"></div>
    ${hold ? $h`
      
      <div class="hold">
      <${eee} key='y' size='120' fsize='150'/>

      <div class="control">
        <div class="50">
          <div class="pl btnn" @click=${(e)=>{ change(cup1)}}>+</div>
            ${cup1}
          <div class="mi btnn" @click=${(e)=>{ change(cup1*-1)}}>-</div>
        </div>
        <div class="100">
          <div class="pl btnn" @click=${(e)=>{ change(cup2)}}>+</div>
          ${cup2}
          <div class="mi btnn" @click=${(e)=>{ change(cup2*-1)}}>-</div>
        </div>
        <div class="200">
          <div class="pl btnn" @click=${(e)=>{ change(cup3)}}>+</div>
          ${cup3}
          <div class="mi btnn" @click=${(e)=>{ change(cup3*-1)}}>-</div>
        </div>
      </div>
      </div>


    ` : $h`
    <span>Водичка</span>
    <!-- <img src="static/bottle.svg" alt=""/> -->
    ${!$store.state.appData.desktop ? $h`
      <div class="gaugeControl">
        <div @click=${(e)=>{change(-100, true, e.target)}} class="minus btn">-100</div>
        <${eee} key='l' fsize='100' size='80'/>
        <div @click=${(e)=>{change(100, true, e.target)}} class="plus btn">+100</div>
      </div>
      ` : $h`
      <${waterBox}/>
      <div class="la">выберите, сколько выпили:</div>
      <div class="cups">
        <${cup} num='1' scale='0.6' img1='cup50'/>
        <${cup} num='2' scale='0.8' img1='cup100'/>
        <${cup} num='3' scale='1' img1='cup200'/>
      </div>
      `}
    `}

  </div>
</template>
<style>
  .cardd.water {
  display: flex;
  justify-content: space-around;
  flex-direction: column;
  transform: scale(1);
  transition: 0.8s cubic-bezier(0.04, 0.93, 0.76, 0.98);
  box-shadow: var(--waterCardBSH);
  background: var(--waterCardGrad);
  margin-bottom: 2rem;
}
@media (min-width: 900px) {
  .cardd.water {
    margin-right: 1rem;
  }
}
.cardd.water::after {
  content: '';
  z-index: 2;
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
}
.cardd.water.active-state {
  transform: scale(0.93);
  transition: 0.3s cubic-bezier(0.92, 0.01, 1, 0.9) !important;
}
@media (min-width: 900px) {
  .cardd.water.active-state {
    transform: scale(0.99);
  }
}
.cardd.water #teachCircle {
  height: 4rem;
  position: absolute;
  z-index: 2;
  width: 4rem;
  opacity: 1;
  transition: opacity 0.4s ease;
  left: 26%;
  top: 40%;
  transform: translate(-50%, -50%);
}
.cardd.water .zPlane {
  content: '';
  z-index: 3;
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
}

  body.theme-dark .cardd.water .water {
    opacity: 0.7;
  }
.cardd.water span {
  color: #73bcc5;
  font-weight: 900;
  font-size: 26pt;
}

  body.theme-dark .cardd.water span {
    color: #3a4768;
  }

@media (min-width: 900px) {
  .cardd.water span {
    font-size: 35pt;
    margin-bottom: 3rem;
  }
}
.cardd.water .waterBox {
  position: absolute;
  z-index: 2;
  right: 2.5rem;
  top: 2.5rem;
  width: 7rem;
  color: #394a52;
  height: 7rem;
  box-shadow: none;
  border: 4px #ffffff59 solid;
}

body.theme-dark .cardd.water .waterBox {
    border: 4px rgba(0, 0, 0, 0.548) solid;
    color: #a7c0cc;
    
  }

  body.theme-dark .cardd.water .waterBox .water{
    filter: brightness(0.8);
  }

.cardd.water .waterBox::after {
  content: '';
}
.cardd.water .la {
  opacity: 0.5;
  margin-left: 1rem;
}
.cardd.water .cups {
  margin-bottom: 0rem;
  z-index: 4;
  position: relative;
}
.cardd.water .cups .cup {
  margin: 1rem 1rem 0rem;
}
.cardd.water .gaugeControl {
  display: flex;
  align-items: center;
  justify-content: flex-end;
}
.cardd.water .gaugeControl .btn {
  color: #65b7c3;
  background-color: rgba(255, 255, 255, 0.52157);
  border-radius: 10rem;
  width: 2.5rem;
  height: 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8pt;
  margin: 0.6rem;
  transform: scale(1);
  transition: 0.2s;
  z-index: 4;
  position: relative;
}

body.theme-dark .cardd.water .gaugeControl .btn {
    color: #136c79;
  }

.cardd.water .gaugeControl .btn::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  padding: 30px;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
.cardd.water .gaugeControl .gaugeBox {
  color: red;
  align-self: flex-end;
}
.cardd.water .gaugeControl .gaugeBox .gauge {
  font-size: 85%;
}
.cardd.water .hold {
  display: flex;
  justify-content: space-around;
  flex-direction: row;
  align-items: center;
  height: 100%;
}
.cardd.water .hold .gauge {
  transform: scale(1);
  font-size: 120%;
}
.cardd.water .hold .control {
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: 4;
}
.cardd.water .hold .control > div {
  color: #000000b5;
  background-color: #ffffff7a;
  margin: 0.6rem 0rem;
  box-sizing: border-box;
  padding: 0.6rem 2.3rem;
  border-radius: 100rem;
  border: 1px #65b7c391 solid;
  position: relative;
  display: flex;
}
.cardd.water .hold .control > div .pl {
  color: #87e2be;
  font-size: 2.7rem;
  position: absolute;
  z-index: 4;
  right: 3px;
  top: 50%;
  line-height: 2.7rem;
  transform: translateY(-53%);
}
.cardd.water .hold .control > div .pl::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  padding: 10px;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
.cardd.water .hold .control > div .mi {
  color: #f7a1a1;
  font-size: 2.7rem;
  position: absolute;
  z-index: 4;
  left: 6px;
  top: 50%;
  line-height: 2.7rem;
  transform: translateY(-53%);
}
.cardd.water .hold .control > div .mi::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  padding: 10px;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
</style>
<script>
    import waterBox from './../../water/waterBox.f7.html';
  import cup from './../../water/cup.f7.html';
  import gauge from './waterGauge.f7.html'
  import eee from './eee.f7.html'

  import lottie from 'lottie-web'
  export default (props, {$store, $f7, $update, $el, $, $onMounted}) => {

    let cup1=$store.state.userData.water.cup1
    let cup2=$store.state.userData.water.cup2
    let cup3=$store.state.userData.water.cup3
    $f7.on('e-cupMlChange', ()=>{
       cup1=$store.state.userData.water.cup1
     cup2=$store.state.userData.water.cup2
     cup3=$store.state.userData.water.cup3
      $update()
    })

    let hold = false
    
    function bouns(el) {
      el.style.transform='scale(1.1)'
      setTimeout(() => {
        el.style.transform=''
      }, 200);
    }


        

    $f7.on('e-waterChange', (val)=>{
      change(val)
    })

    let arrr = [0,1,2]

    let newarrr = document

    function change(ml, b=false, el) {



      if ($store.state.userData.water.todayMl >= $store.state.userData.water.goal &&
      $store.state.userData.water.todayMl+ml < $store.state.userData.water.goal) {

        $f7.emit('e-goal', '-')
      }else if($store.state.userData.water.todayMl < $store.state.userData.water.goal &&
      $store.state.userData.water.todayMl+ml >= $store.state.userData.water.goal){
        $f7.emit('e-goal', '+')
      }

      if ($store.state.userData.water.todayMl+ml >= 0) {
        $store.state.userData.water.todayMl+=ml
        doo()
      }else if ($store.state.userData.water.todayMl == 0 && ml<=0){

      }else if ($store.state.userData.water.todayMl+ml <0){
        $store.state.userData.water.todayMl=0
        doo()
      }

      

      

      function doo() {
        if (b) { bouns(el)}
      $store.state.gf.vibrate('lil success')

      $f7.emit('e-backp')
      $f7.emit('e-waterChange')
      }



    }

    function holdChange() {
      // navigator.vibrate([30, 10, 30,])
      $store.state.gf.vibrate('success')
        $f7.emit('e-waterCardHold')
        hold=hold?false:true
        $update()
    }


    var toastBottom = $f7.toast.create({
      text: 'Зажмите на карточке для дополнительных действий',
      closeButton: true
    });
    toastBottom.on('closeButtonClick', ()=>{
      $store.state.userData.teach.widgetPress = true
      callCardClickTeach()
      $f7.emit('e-backp')
    })

    let toastClickCard = $f7.toast.create({
      text: 'Клик по карточке — перейти на отдельную страницу',
      closeButton: true
    });
    toastClickCard.on('closeButtonClick', ()=>{
      $store.state.userData.teach.cardClick=true
      $f7.emit('e-backp')
    })

    function callCardClickTeach() {
      if (!$store.state.userData.teach.cardClick) {
        setTimeout(() => {
          toastClickCard.open()
        }, 2000);
      }
    }


    $onMounted(()=>{
      $($el.value[0]).on('taphold', function () {
        if ($store.state.userData.teach.widgetPress !== true) {
          $store.state.userData.teach.widgetPress=true
          callCardClickTeach()
          $f7.emit('e-backp')
        }
        toastBottom.close()
        holdChange()
      });




      if ($store.state.userData.teach.widgetPress !== true && !$store.state.appData.desktop) {
      setTimeout(() => {
        
        toastBottom.open();

        setTimeout(() => {
          var animation = lottie.loadAnimation({
          container: document.getElementById('teachCircle'), // Required
          path: 'static/teachCircle.json', // Required
          renderer: 'svg', // Required
          loop: false,
          autoplay: false, // Optional
        })
        $($el.value[0]).css('box-shadow', 'var(--waterCardBSH), 0 0 0 1000px #0000005e')

        animation.play()  
        animation.pause()  
        
        setTimeout(() => {
          animation.setSpeed(1)  
          animation.play()  
        


        $($el.value[0]).addClass('active-state')


        setTimeout(() => {
          $($el.value[0]).removeClass('active-state')

          holdChange()
          $('#teachCircle').css('opacity', '0')
          setTimeout(() => {
            $('#teachCircle').remove()
             animation.destroy()

            $($el.value[0]).css('box-shadow', 'var(--waterCardBSH)')

          }, 500);
        }, 500);
        }, 1000);
        }, 3000);
      }, 2500);

      }
      
      if (!$store.state.userData.teach.cardClick && $store.state.appData.desktop){
        callCardClickTeach()
      }

      function nav(){
        if (!$store.state.userData.teach.cardClick) {
          $store.state.userData.teach.cardClick=true
          $f7.emit('e-backp')

          toastClickCard.close()
        }
        app.views.current.router.navigate('/water/')
      }


      function redir(ev, skip) {
        
        let path = ev.path
      let fClasses = [...path[0].classList]
      let no = ['btn', 'btnn', 'cup']
      if (!no.some(el => fClasses.join(' ').includes(el))) {
        nav()
      }

      
    }


    $('.cardd.water').on('click', (e)=>{
      
      if (e.altitudeAngle==null && e.toElement.classList.contains('cardd')) {
        nav()
      }else if(e.target.classList.contains('cardd')){
        nav()
      }
      
      
    })

    

    })

    



    return $render;
  }
</script>