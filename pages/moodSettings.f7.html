<template>
  <div class="page set" data-name="settings">
    <div class="page-content">
      <div class="header">
        Настройки настроения <br /><br />
        кам инг сун
      </div>




    </div>
  </div>
</template>
<script>

  export default (props, { $store, $onMounted, $f7, $, $update, $el }) => {

    var pickerDevice;

    function openPicker() {
      pickerDevice.open()
    }

    function done(val) {
      //val - новая цель

      // if (+val < $store.state.userData.water.goal && $store.state.userData.water.goal > $store.state.userData.water.todayMl) {
      //   $f7.emit('e-goal', '+')
      // }else if (+val >  $store.state.userData.water.goal && $store.state.userData.water.goal < $store.state.userData.water.todayMl) {
      //   $f7.emit('e-goal', '-')
      // }

      // if ($store.state.userData.water.todayMl >= $store.state.userData.water.goal &&  old---------------
      // $store.state.userData.water.todayMl+ml < $store.state.userData.water.goal) {

      //   $f7.emit('e-goal', '-')
      // }else if($store.state.userData.water.todayMl < $store.state.userData.water.goal &&
      // $store.state.userData.water.todayMl+ml >= $store.state.userData.water.goal){
      //   $f7.emit('e-goal', '+')
      // }
      let oldG = $store.state.userData.water.goal
      let todayMl = $store.state.userData.water.todayMl

      if (val>oldG && oldG <= todayMl && val > todayMl) {
        $f7.emit('e-goal', '-')
      } else if (val < oldG && oldG > todayMl && val <= todayMl){
        $f7.emit('e-goal', '+')
      }
      
      $store.state.userData.water.goal = +(val)
      $store.state.userData.water.hisVal = true

      app.emit('e-waterChange', 0)
      app.emit('e-waterPageChange')

      
      

      $store.state.gf.vibrate([30, 60, 30])

      $update()
      $f7.emit('e-backp')
    }

    function count() {
      let hours = $el.value[0].querySelector('.hours').value
      let weight = $el.value[0].querySelector('.weight').value
      let gen = $el.value[0].querySelector('.gen').value

      let water
      if (gen == 'Male') {
        water = (weight * 0.02) + hours * 0.3
      } else {
        water = (weight * 0.015) + hours * 0.25
      }

      let waterMl=Math.trunc(water * 1000)

      let confirm = $f7.dialog.create({
        closeByBackdropClick:true,
        title:'Настройки воды',
        text:`По расчётам, ваша норма — ${waterMl}мл. Установить её?`,
        buttons:[
          {
            text:'не то',
            keyCodes:[27],
          },
          {
            text:'да',
            bold:true,
            keyCodes:[13],
            onClick:()=>{
              done(waterMl)
            }
          }
        ]
      })

      if ($store.state.userData.water.goal!==waterMl) {
        confirm.open()
      }
    }


    $onMounted(() => {

      let arr144 = []
      for (let i = 0; i < 101; i = i + 2) {
        arr144.push(i * 100 + 'мл')
      }


      pickerDevice = $f7.picker.create({
        inputEl: '#demo-picker-device',
        rotateEffect: true,
        backdrop: true,
        cssClass: 'picker',
        openIn: 'popover',
        routableModals: true,
        toolbarCloseText: 'как раз для меня',
        cols: [
          {
            values: arr144.slice(1)
          }
        ]
      });

      pickerDevice.once('opened', (el) => {
        el.setValue([Math.round(($store.state.userData.water.goal / 100)) * 100 + 'мл'], 300)

      })

      pickerDevice.on('opened', (el) => {

        $('.picker-3d .sheet-close').on('click', () => {
          done(+(pickerDevice.value[0].slice(0, -2)))

        })

        $('.picker-3d .picker-item').on('click', (e) => {
          console.log([...e.target.parentElement.classList].indexOf('picker-item-selected') !== -1);
        })
      })
      pickerDevice.on('change', (el) => {

        $store.state.gf.vibrate(30)
      })


    })
    return $render;
  };
</script>