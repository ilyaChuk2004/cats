<template>
  <div class="cardd water">
    <div id="teachCircle"></div>
    ${hold ? $h`
      
      <div class="hold">
      <${eee} key='y' size='120' fsize='150'/>

      <div class="control">
        <div class="50">
          <div class="pl btnn" @click=${(e)=>{ change(100)}}>+</div>
            100
          <div class="mi btnn" @click=${(e)=>{ change(-100)}}>-</div>
        </div>
        <div class="100">
          <div class="pl btnn" @click=${(e)=>{ change(200)}}>+</div>
            200
          <div class="mi btnn" @click=${(e)=>{ change(-200)}}>-</div>
        </div>
        <div class="200">
          <div class="pl btnn" @click=${(e)=>{ change(300)}}>+</div>
            300
          <div class="mi btnn" @click=${(e)=>{ change(-300)}}>-</div>
        </div>
      </div>
      </div>


    ` : $h`
    <span>Водичка</span>
    <!-- <img src="static/bottle.svg" alt=""/> -->
    ${!$store.state.appData.desktop ? $h`
      <div class="gaugeControl">
        <div @click=${(e)=>{change(-100, true, e.target)}} class="minus btn">-100</div>
        <${eee} key='l' fsize='100' size='80'/>
        <div @click=${(e)=>{change(100, true, e.target)}} class="plus btn">+100</div>
      </div>
      ` : $h`
      <${waterBox}/>
      <div class="la">выберите, сколько выпили:</div>
      <div class="cups">
        <${cup} ml='100' scale='0.6' img1='cup50'/>
        <${cup} ml='200' scale='0.8' img1='cup100'/>
        <${cup} ml='300' scale='1' img1='cup200'/>
      </div>
      `}
    `}

  </div>
</template>
<script>
    import waterBox from './../../water/waterBox.f7.html';
  import cup from './../../water/cup.f7.html';
  import gauge from './waterGauge.f7.html'
  import eee from './eee.f7.html'
  export default (props, {$store, $f7, $update, $el, $, $onMounted}) => {
    var bodymovin = require('../../../js/lottie');



    let hold = false
    
    function bouns(el) {
      el.style.transform='scale(1.1)'
      setTimeout(() => {
        el.style.transform=''
      }, 200);
    }


        

    $f7.on('e-waterChange', (val)=>{
      change(val)
    })

    let arrr = [0,1,2]

    let newarrr = document

    function change(ml, b=false, el) {



      if ($store.state.userData.water.todayMl >= $store.state.userData.water.goal &&
      $store.state.userData.water.todayMl+ml < $store.state.userData.water.goal) {

        $f7.emit('e-goal', '-')
      }else if($store.state.userData.water.todayMl < $store.state.userData.water.goal &&
      $store.state.userData.water.todayMl+ml >= $store.state.userData.water.goal){
        $f7.emit('e-goal', '+')
      }

      if ($store.state.userData.water.todayMl+ml >= 0) {
        $store.state.userData.water.todayMl+=ml
        doo()
      }else if ($store.state.userData.water.todayMl == 0 && ml<=0){

      }else if ($store.state.userData.water.todayMl+ml <0){
        $store.state.userData.water.todayMl=0
        doo()
      }

      

      

      function doo() {
        if (b) { bouns(el)}
      $store.state.gf.vibrate('lil success')

      $f7.emit('e-backp')
      $f7.emit('e-waterChange')
      }



    }

    function holdChange() {
      // navigator.vibrate([30, 10, 30,])
      $store.state.gf.vibrate('success')
        $f7.emit('e-waterCardHold')
        hold=hold?false:true
        $update()
    }


    var toastBottom = $f7.toast.create({
      text: 'Зажмите на карточке для дополнительных действий',
      closeButton: true
    });
    toastBottom.on('closeButtonClick', ()=>{
      $store.state.userData.teach.widgetPress = true
      callCardClickTeach()
      $f7.emit('e-backp')
    })

    let toastClickCard = $f7.toast.create({
      text: 'Клик по карточке — перейти на отдельную страницу',
      closeButton: true
    });
    toastClickCard.on('closeButtonClick', ()=>{
      $store.state.userData.teach.cardClick=true
      $f7.emit('e-backp')
    })

    function callCardClickTeach() {
      if (!$store.state.userData.teach.cardClick) {
        setTimeout(() => {
          toastClickCard.open()
        }, 2000);
      }
    }


    $onMounted(()=>{
      $($el.value[0]).on('taphold', function () {
        if ($store.state.userData.teach.widgetPress !== true) {
          $store.state.userData.teach.widgetPress=true
          callCardClickTeach()
          $f7.emit('e-backp')
        }
        toastBottom.close()
        holdChange()
      });




      if ($store.state.userData.teach.widgetPress !== true && !$store.state.appData.desktop) {
      setTimeout(() => {
        
        toastBottom.open();

        setTimeout(() => {
          var animation = lottie.loadAnimation({
          container: document.getElementById('teachCircle'), // Required
          path: 'static/teachCircle.json', // Required
          renderer: 'svg', // Required
          loop: false,
          autoplay: false, // Optional
        })
        $($el.value[0]).css('box-shadow', 'var(--waterCardBSH), 0 0 0 1000px #0000005e')

        animation.play()  
        animation.pause()  
        
        setTimeout(() => {
          animation.setSpeed(1)  
          animation.play()  
        


        $($el.value[0]).addClass('active-state')


        setTimeout(() => {
          $($el.value[0]).removeClass('active-state')

          holdChange()
          $('#teachCircle').css('opacity', '0')
          setTimeout(() => {
            $('#teachCircle').remove()
             animation.destroy()

            $($el.value[0]).css('box-shadow', 'var(--waterCardBSH)')

          }, 500);
        }, 500);
        }, 1000);
        }, 3000);
      }, 2500);

      }
      
      if (!$store.state.userData.teach.cardClick && $store.state.appData.desktop){
        callCardClickTeach()
      }

      function nav(){
        if (!$store.state.userData.teach.cardClick) {
          $store.state.userData.teach.cardClick=true
          $f7.emit('e-backp')

          toastClickCard.close()
        }
        app.views.current.router.navigate('/water/')
      }


      function redir(ev, skip) {
        
        let path = ev.path
      let fClasses = [...path[0].classList]
      let no = ['btn', 'btnn', 'cup']
      if (!no.some(el => fClasses.join(' ').includes(el))) {
        nav()
      }

      
    }


    $('.cardd.water').on('click', (e)=>{
      
      if (e.altitudeAngle==null && e.toElement.classList.contains('cardd')) {
        nav()
      }else if(e.target.classList.contains('cardd')){
        nav()
      }
      
      
    })

    

    })

    



    return $render;
  }
</script>