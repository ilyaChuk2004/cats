<template>
  <div @click=${(e)=>{cl(e)}} data-em='${props.emo}' data-num='${props.num}' class="emoji">
    ${props.emoji}
  </div>
</template>
<style>
</style>
<script>
  export default (props, { $store, $f7, $update, $el, $, $onMounted, $onBeforeUnmount }) => {
    
    $store.state.appData.thumbAniTime=0

    let toastClose = $f7.toast.create({
      text: 'Нажмите ещё раз, чтобы записать',
      closeButton: true,
      closeButtonText: 'Окс'
    })
    toastClose.on('closeButtonClick', ()=>{
      $store.state.userData.teach.doubleClickEmoji=true
      $f7.emit('e-backp')
    })

    $f7.on('e-changeEmoji', ()=>{
      // console.log(props);
      $update()
    })

    

    function cl(e) {

      let el = e.target
      console.log(props.role, el.classList);
      if (props.role=='carddd') { 
        if (el.classList.contains('active')) {
        if (props.emoji!=='+') {
          $(el).removeClass('active')
        $store.state.appData.selectedEmoji = ''
          
        $f7.emit('e-writeMood', {
          emo:$store.state.appData.selectedEmojii
        })
        $store.state.appData.selectedEmojii=''
        }else{
           $f7.views.main.router.navigate('/moodWidgetSet/')
        }

        
      } else {
        if (props.emoji!=='+') {
          el.classList.add("active")
        $store.state.appData.selectedEmoji = props.emo
        $store.state.appData.selectedEmojii = props.emoji

        $f7.emit('e-activeNewEmo', props.num)

       

        if (!$store.state.userData.teach.doubleClickEmoji) {
          setTimeout(() => {
            toastClose.open()
          }, 500);
        }
      }else{
           $f7.views.main.router.navigate('/moodWidgetSet/')
           setTimeout(() => {
            $store.state.appData.mood.selectedSettEmoji=props.num
           $store.state.appData.mood.isPlus=true
            $f7.emit('e-redirToSettEmo')
            $f7.emit('e-moodCardEmojiClicked', $el.value[0])
            $f7.emit('e-activeIt', props.num)
           }, 200);
        }
        
        }
      }else{
        el.classList.add("active")
        $f7.emit('e-moodCardEmojiClicked', el)
        $f7.emit('e-activeNewEmo', props.num, props.emoji)
        

        
        if (props.emoji!=='+') {
          $store.state.appData.mood.selectedSettEmoji=props.num
          $store.state.appData.mood.isPlus=false
        }else{
           $store.state.appData.mood.selectedSettEmoji=props.num
           $store.state.appData.mood.isPlus=true
        }
        console.log('num:',$store.state.appData.mood.selectedSettEmoji);
      }

      
      

      //todo вызов события записи эмоции
      


    }

    
    $f7.on('e-activeIt', (id)=>{
        // console.log('atit',props.num, id );
          setTimeout(() => { 
            if(props.num ==id && props.role=='settings'){
            $el.value[0].lastChild.classList.add("active") 
            $store.state.appData.mood.selectedSettEmoji=props.num
            $store.state.appData.mood.isPlus=true
            console.log('DOOONE');
            
          }
          }, 400);
      })

    function def(){
      try {
        $($el.value[0]).removeClass('active') 
      } catch (error) {
        
      }
        $store.state.appData.selectedEmoji = ''
        $store.state.appData.selectedEmojii=''
    }

    $f7.on('e-writedMood', ()=>{def()})

    $f7.on('e-activeNewEmo', (id,s)=>{
        console.log(props.num, id)
          if(props.num !==id){
            $($el.value[0]).removeClass('active')
          }else{ 
            if (s=='+') {
            $store.state.appData.mood.isPlus=true
            }else{
            $store.state.appData.mood.isPlus=false
            }
            $store.state.appData.mood.selectedSettEmoji=props.num
            $el.value[0].classList.add("active") 
          }
      })

    $onMounted(() => {
      

      var ell = $el.value[0]
      $f7.on('e-moodCardHold', () => {
        $f7.emit('e-activeNewEmo', $store.state.appData.mood.selectedSettEmoji, '')
      })
    })
    $onBeforeUnmount(()=>{
      $f7.off('e-activeNewEmo')
    })
    return $render;
  }
</script>